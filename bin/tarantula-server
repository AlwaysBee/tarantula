#!/usr/bin/env node

'use strict'

const program = require("commander"),
            _ = require("lodash"),
          pm2 = require('pm2'),
         path = require("path"),
           fs = require("fs"),
     bluebird = require("bluebird")

const version = (() => {
  try{
   return require("tarantula/package.json").version
  }catch(e){
   return 'dev'
  }
})()

program
  .version(version)
  .option("--init", "init config")
  .option('--start', "start a server")
  .option('--stop', "stop the server")

  .option('-p --port <port>', "listen port")
  .option('--db_config <path>', "database config path")
  .option('--config <path>', "tarantula config path")
  .parse(process.argv)


async function initConfig(){
  const dbPath = require.resolve("tarantulajs/config/database.json.sample")
  const configPath = require.resolve("tarantulajs/config/tarantula-config.json.sample")

  fs.copyFileSync(dbPath, 'database.json')
  fs.copyFileSync(configPath, 'tarantula-config.json')
}

;(async () => {
  if (program.init){
    return initConfig()
  }

  const configPath = require.resolve("tarantulajs/pm2.json")
  const config = _.chain(require(configPath)).get("apps").map((n) => {
    return _.merge(n, {
      cwd: path.dirname(configPath),
      env: {
        NODE_ENV: process.env.NODE_ENV || "production",
        DB_CONFIG: path.resolve(program["db_config"]),
        TARANTULA_CONFIG: path.resolve(program["config"]),
      },

      args: `${n.args || ""} ${program.port ? "--port " + program.port : ""}`
    })
  }).thru((items) => ({apps: items})).value()

  pm2.connect(async function(err) {
    if (err) {
      console.error(err)
      process.exit(2)
    }

    if (program.start){
      pm2.start(config, (err, apps) => {
        if (err){
          console.error(err)
        }

        console.log(`server started. http://localhost:${program.port || 3000}`)
        pm2.disconnect();
      })
    }else if (program.stop){
      const appNames = _.chain(config).get("apps").map("name").value()

      bluebird.map(appNames, (n) => {
        return new Promise((resolve, reject) => {
          pm2.delete(n, (err) => {
            if (err){
              reject(err)
              return
            }

            resolve()
          })
        })
      }).then(() => {
        pm2.list((err, apps) => {
          if (apps.length > 0){
            pm2.disconnect();
            return
          }

          pm2.killDaemon((err) => {
            if (err){
              console.error(err)
            }

            process.exit()
          })
        })
      })
    }else{
      process.exit()
    }
  })
})()
